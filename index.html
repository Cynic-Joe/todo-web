<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∫∏ÈªÑÂæÖÂäû</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #FFF8DC;
            --card-bg: #FFFAE8;
            --text-primary: #5D4E37;
            --text-secondary: #8B7355;
            --border-color: #E8DCC8;
            --shadow-color: rgba(93, 78, 55, 0.1);
            --btn-bg: #5D4E37;
            --btn-text: #FFFAE8;
            --btn-hover: #4A3F2D;
            --delete-color: #C75D5D;
            --delete-hover: #A84848;
            --input-bg: #FFFAE8;
            --placeholder-color: #B8A889;
            --sync-success: #5D8E5D;
            --sync-error: #C75D5D;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 16px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 4px;
        }

        .header .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ËÆæÁΩÆÂå∫Âüü */
        .settings {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .settings-header h3 {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .settings-toggle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .settings-content {
            display: none;
            margin-top: 16px;
        }

        .settings-content.show {
            display: block;
        }

        .settings-group {
            margin-bottom: 12px;
        }

        .settings-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .settings-group input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .settings-group input:focus {
            outline: none;
            border-color: var(--text-secondary);
        }

        .settings-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--btn-bg);
            color: var(--btn-text);
        }

        .btn-primary:hover {
            background: var(--btn-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--sync-success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sync-status {
            font-size: 12px;
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }

        .sync-status.show {
            display: block;
        }

        .sync-status.success {
            background: rgba(93, 142, 93, 0.15);
            color: var(--sync-success);
        }

        .sync-status.error {
            background: rgba(199, 93, 93, 0.15);
            color: var(--sync-error);
        }

        .sync-status.loading {
            background: rgba(139, 115, 85, 0.15);
            color: var(--text-secondary);
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--text-secondary);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .input-wrapper input::placeholder {
            color: var(--placeholder-color);
        }

        .add-btn {
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 500;
            background-color: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
        }

        .add-btn:hover {
            background-color: var(--btn-hover);
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        .todo-list {
            list-style: none;
        }

        .todo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 12px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: fadeIn 0.3s ease;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .todo-item .todo-text {
            flex: 1;
            font-size: 16px;
            word-break: break-word;
        }

        .todo-item .delete-btn {
            padding: 8px 16px;
            font-size: 14px;
            background-color: transparent;
            color: var(--delete-color);
            border: 1px solid var(--delete-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 12px;
        }

        .todo-item .delete-btn:hover {
            background-color: var(--delete-color);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
        }

        .todo-count {
            text-align: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        .todo-item.removing {
            animation: fadeOut 0.3s ease forwards;
        }

        /* ËÆ∞Ë¥¶Âå∫ÂüüÊ†∑Âºè */
        .accounting-section {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 2px solid var(--border-color);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .balance-display {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 700;
            color: var(--delete-color);
        }

        .balance-amount.expense {
            color: var(--sync-success);
        }

        .income-btn {
            flex: 1;
            background: var(--delete-color);
            color: white;
            font-weight: 600;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(199, 93, 93, 0.3);
        }

        .income-btn:hover {
            background: var(--delete-hover);
            box-shadow: 0 6px 16px rgba(199, 93, 93, 0.4);
            transform: translateY(-2px);
        }

        .expense-btn {
            flex: 1;
            background: var(--sync-success);
            color: white;
            font-weight: 600;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(93, 142, 93, 0.3);
        }

        .expense-btn:hover {
            background: #4a7a4a;
            box-shadow: 0 6px 16px rgba(93, 142, 93, 0.4);
            transform: translateY(-2px);
        }

        .records-section {
            margin-top: 24px;
        }

        .records-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .record-item.income .record-amount {
            color: var(--delete-color);
        }

        .record-item.expense .record-amount {
            color: var(--sync-success);
        }

        .record-list {
            list-style: none;
        }

        .record-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            margin-bottom: 10px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
        }

        .record-item .record-info {
            flex: 1;
        }

        .record-item .record-amount {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 12px;
        }

        .record-item .record-note {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .record-item .record-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .record-item .delete-btn {
            padding: 6px 12px;
            font-size: 13px;
            background-color: transparent;
            color: var(--delete-color);
            border: 1px solid var(--delete-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .record-item .delete-btn:hover {
            background-color: var(--delete-color);
            color: white;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 24px;
                letter-spacing: 2px;
            }

            .input-group {
                flex-direction: column;
                gap: 10px;
            }

            .add-btn {
                width: 100%;
                padding: 14px;
            }

            .todo-item {
                padding: 14px;
            }

            .todo-item .delete-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .settings-actions {
                flex-direction: column;
            }

            .settings-actions .btn {
                width: 100%;
            }
        }

        @media (min-width: 768px) {
            .container {
                padding: 48px 24px;
            }

            .header h1 {
                font-size: 32px;
            }

            .todo-item {
                padding: 18px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ÂæÖÂäû‰∫ãÈ°π</h1>
            <p class="subtitle">ËÆ∞ÂΩïÊØè‰∏ÄÂ§©ÁöÑÂæÖÂäû</p>
        </header>

        <!-- ËÆæÁΩÆÂå∫Âüü -->
        <div class="settings">
            <div class="settings-header" id="settingsToggle">
                <h3>‰∫ëÂêåÊ≠•ËÆæÁΩÆ (GitHub Gist)</h3>
                <span class="settings-toggle" id="toggleIcon">Â±ïÂºÄ</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="settings-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div class="settings-group">
                    <label>Gist IDÔºàÈ¶ñÊ¨°ÁïôÁ©∫ÂàõÂª∫Êñ∞GistÔºâ</label>
                    <input type="text" id="gistId" placeholder="xxxxxx">
                </div>
                <div class="settings-group">
                    <label>
                        <input type="checkbox" id="autoSync" style="width:auto;margin-right:8px;">
                        Ëá™Âä®ÂêåÊ≠•ÔºàÊ∑ªÂä†/Âà†Èô§ÂæÖÂäûÂêéËá™Âä®‰∏ä‰º†Ôºâ
                    </label>
                </div>
                <div class="settings-group">
                    <label>
                        <input type="checkbox" id="autoPull" style="width:auto;margin-right:8px;">
                        Ëá™Âä®ÊãâÂèñÔºàÊâìÂºÄÈ°µÈù¢Êó∂Ëá™Âä®‰∏ãËΩΩ‰∫ëÁ´ØÊï∞ÊçÆÔºâ
                    </label>
                </div>
                <div class="settings-actions">
                    <button class="btn btn-primary" id="syncBtn">ÂêåÊ≠•Âà∞‰∫ëÁ´Ø</button>
                    <button class="btn btn-secondary" id="pullBtn">‰ªé‰∫ëÁ´ØÊãâÂèñ</button>
                </div>
                <div class="sync-status" id="syncStatus"></div>
            </div>
        </div>

        <div class="input-group">
            <div class="input-wrapper">
                <input type="text" id="todoInput" placeholder="Ê∑ªÂä†Êñ∞ÁöÑÂæÖÂäû‰∫ãÈ°π..." maxlength="100">
            </div>
            <button class="add-btn" id="addBtn">Ê∑ªÂä†</button>
        </div>

        <ul class="todo-list" id="todoList"></ul>

        <div class="empty-state" id="emptyState">
            <div class="icon">üìù</div>
            <p>ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π</p>
        </div>

        <div class="todo-count" id="todoCount"></div>

        <!-- ËÆ∞Ë¥¶Âå∫Âüü -->
        <div class="accounting-section">
            <h2 class="section-title">ËÆ∞Ë¥¶</h2>
            <div class="balance-display">
                <span class="balance-label">Á¥ØËÆ°Êî∂ÂÖ•</span>
                <span class="balance-amount" id="totalBalance">¬•0</span>
            </div>

            <div class="balance-display" style="margin-top: 16px;">
                <span class="balance-label">Á¥ØËÆ°ÊîØÂá∫</span>
                <span class="balance-amount expense" id="totalExpense">¬•0</span>
            </div>

            <div class="input-group">
                <div class="input-wrapper">
                    <input type="text" id="noteInput" placeholder="‰∫ã‰ª∂" maxlength="50">
                </div>
                <div class="input-wrapper">
                    <input type="number" id="amountInput" placeholder="ÈáëÈ¢ù" min="0">
                </div>
            </div>
            <div class="input-group" style="gap: 8px;">
                <button class="add-btn income-btn" id="addIncomeBtn">ËÆ∞Êî∂ÂÖ•</button>
                <button class="add-btn expense-btn" id="addExpenseBtn">ËÆ∞ÊîØÂá∫</button>
            </div>

            <div class="records-section">
                <h3 class="records-title">Êî∂ÂÖ•ËÆ∞ÂΩï</h3>
                <ul class="record-list" id="incomeList"></ul>
                <div class="empty-state" id="emptyIncomeState">
                    <div class="icon">üí∞</div>
                    <p>ÊöÇÊó†Êî∂ÂÖ•ËÆ∞ÂΩï</p>
                </div>
            </div>

            <div class="records-section">
                <h3 class="records-title">ÊîØÂá∫ËÆ∞ÂΩï</h3>
                <ul class="record-list" id="expenseList"></ul>
                <div class="empty-state" id="emptyExpenseState">
                    <div class="icon">üí∏</div>
                    <p>ÊöÇÊó†ÊîØÂá∫ËÆ∞ÂΩï</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Êï∞ÊçÆÂ≠òÂÇ®
        const DATA_STORAGE_KEY = 'zhihuang_data';
        const GITHUB_TOKEN_KEY = 'zhihuang_github_token';
        const GIST_ID_KEY = 'zhihuang_gist_id';
        const AUTO_SYNC_KEY = 'zhihuang_auto_sync';
        const AUTO_PULL_KEY = 'zhihuang_auto_pull';
        let isAutoSyncing = false;

        // Ê£ÄÊü• localStorage ÊòØÂê¶ÂèØÁî®
        let storage = localStorage;
        try {
            localStorage.setItem('__test__', 'test');
            localStorage.removeItem('__test__');
        } catch (e) {
            console.warn('localStorage ‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
            storage = {
                _data: {},
                getItem: function(key) { return this._data[key] || null; },
                setItem: function(key, value) { this._data[key] = value; },
                removeItem: function(key) { delete this._data[key]; }
            };
        }

        // DOM ÂÖÉÁ¥†
        const todoInput = document.getElementById('todoInput');
        const addBtn = document.getElementById('addBtn');
        const todoList = document.getElementById('todoList');
        const emptyState = document.getElementById('emptyState');
        const todoCount = document.getElementById('todoCount');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');
        const toggleIcon = document.getElementById('toggleIcon');
        const githubTokenInput = document.getElementById('githubToken');
        const gistIdInput = document.getElementById('gistId');
        const autoSyncCheckbox = document.getElementById('autoSync');
        const autoPullCheckbox = document.getElementById('autoPull');
        const syncBtn = document.getElementById('syncBtn');
        const pullBtn = document.getElementById('pullBtn');
        const syncStatus = document.getElementById('syncStatus');

        // ËÆ∞Ë¥¶Áõ∏ÂÖ≥ DOM
        const amountInput = document.getElementById('amountInput');
        const noteInput = document.getElementById('noteInput');
        const addIncomeBtn = document.getElementById('addIncomeBtn');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const incomeList = document.getElementById('incomeList');
        const expenseList = document.getElementById('expenseList');
        const emptyIncomeState = document.getElementById('emptyIncomeState');
        const emptyExpenseState = document.getElementById('emptyExpenseState');
        const totalBalanceEl = document.getElementById('totalBalance');
        const totalExpenseEl = document.getElementById('totalExpense');

        // ÂàùÂßãÂåñËÆæÁΩÆ
        githubTokenInput.value = storage.getItem(GITHUB_TOKEN_KEY) || '';
        gistIdInput.value = storage.getItem(GIST_ID_KEY) || '';
        autoSyncCheckbox.checked = storage.getItem(AUTO_SYNC_KEY) === 'true';
        autoPullCheckbox.checked = storage.getItem(AUTO_PULL_KEY) === 'true';

        // ‰øùÂ≠òËá™Âä®ÂêåÊ≠•ËÆæÁΩÆ
        autoSyncCheckbox.addEventListener('change', () => {
            storage.setItem(AUTO_SYNC_KEY, autoSyncCheckbox.checked);
        });

        // ‰øùÂ≠òËá™Âä®ÊãâÂèñËÆæÁΩÆ
        autoPullCheckbox.addEventListener('change', () => {
            storage.setItem(AUTO_PULL_KEY, autoPullCheckbox.checked);
        });

        // ËæìÂÖ•Ê°ÜÂèòÂåñÊó∂Ëá™Âä®‰øùÂ≠ò Token Âíå Gist ID
        githubTokenInput.addEventListener('input', () => {
            const token = githubTokenInput.value.trim();
            if (token) {
                storage.setItem(GITHUB_TOKEN_KEY, token);
            }
        });

        gistIdInput.addEventListener('input', () => {
            const gistId = gistIdInput.value.trim();
            if (gistId) {
                storage.setItem(GIST_ID_KEY, gistId);
            }
        });

        // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®ÊãâÂèñ
        if (autoPullCheckbox.checked) {
            pullFromCloud();
        }

        // ËÆæÁΩÆÈù¢ÊùøÂ±ïÂºÄ/Êî∂Ëµ∑
        settingsToggle.addEventListener('click', () => {
            settingsContent.classList.toggle('show');
            toggleIcon.textContent = settingsContent.classList.contains('show') ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ';
        });

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatus(message, type) {
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status show ' + type;
            setTimeout(() => {
                syncStatus.classList.remove('show');
            }, 4000);
        }

        // GitHub API Ë∞ÉÁî®
        async function githubRequest(endpoint, method, body = null) {
            const token = githubTokenInput.value.trim();
            if (!token) {
                throw new Error('ËØ∑ËæìÂÖ• GitHub Token');
            }

            const headers = {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
            };

            if (body) {
                headers['Content-Type'] = 'application/json';
            }

            const options = {
                method: method,
                headers: headers
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch('https://api.github.com' + endpoint, options);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'ËØ∑Ê±ÇÂ§±Ë¥•');
            }

            return response.json();
        }

        // ÂàõÂª∫Êñ∞ Gist
        async function createGist(data) {
            const gist = await githubRequest('/gists', 'POST', {
                description: 'Á∫∏ÈªÑÂæÖÂäûÊï∞ÊçÆ',
                public: false,
                files: {
                    'data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            });
            return gist.id;
        }

        // Êõ¥Êñ∞ Gist
        async function updateGist(gistId, data) {
            await githubRequest('/gists/' + gistId, 'PATCH', {
                files: {
                    'data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            });
        }

        // Ëé∑Âèñ Gist ÂÜÖÂÆπ
        async function getGist(gistId) {
            const gist = await githubRequest('/gists/' + gistId, 'GET');
            const content = gist.files['data.json'].content;
            return JSON.parse(content);
        }

        // ÂêåÊ≠•Âà∞‰∫ëÁ´Ø
        async function syncToCloud() {
            const token = githubTokenInput.value.trim();
            if (!token) {
                showStatus('ËØ∑ÂÖàËæìÂÖ• GitHub Token', 'error');
                return;
            }

            syncBtn.disabled = true;
            pullBtn.disabled = true;
            showStatus('Ê≠£Âú®ÂêåÊ≠•...', 'loading');

            try {
                const data = getData();
                let gistId = gistIdInput.value.trim();

                // ‰øùÂ≠ò token Âíå gistId
                storage.setItem(GITHUB_TOKEN_KEY, token);

                if (gistId) {
                    // Êõ¥Êñ∞Áé∞Êúâ Gist
                    await updateGist(gistId, data);
                    showStatus('ÂêåÊ≠•ÊàêÂäüÔºÅ', 'success');
                } else {
                    // ÂàõÂª∫Êñ∞ Gist
                    gistId = await createGist(data);
                    gistIdInput.value = gistId;
                    storage.setItem(GIST_ID_KEY, gistId);
                    showStatus('ÂàõÂª∫ Gist ÊàêÂäüÔºåËØ∑ËÆ∞ÂΩï‰∏ãÊñπÁöÑ Gist IDÔºÅ', 'success');
                }
            } catch (error) {
                showStatus('ÂêåÊ≠•Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                syncBtn.disabled = false;
                pullBtn.disabled = false;
            }
        }

        // ‰ªé‰∫ëÁ´ØÊãâÂèñ
        async function pullFromCloud() {
            const token = githubTokenInput.value.trim();
            const gistId = gistIdInput.value.trim();

            if (!token) {
                showStatus('ËØ∑ÂÖàËæìÂÖ• GitHub Token', 'error');
                return;
            }

            if (!gistId) {
                showStatus('ËØ∑ÂÖàËæìÂÖ• Gist ID ÊàñÂÖàÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'error');
                return;
            }

            syncBtn.disabled = true;
            pullBtn.disabled = true;
            showStatus('Ê≠£Âú®ÊãâÂèñ...', 'loading');

            try {
                const data = await getGist(gistId);
                saveData(data);
                renderTodos();
                renderRecords();
                showStatus('ÊãâÂèñÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                showStatus('ÊãâÂèñÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                syncBtn.disabled = false;
                pullBtn.disabled = false;
            }
        }

        // Ëá™Âä®ÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºà‰∏çÂºπÁ™óÔºåÈùôÈªòÂêåÊ≠•Ôºâ
        async function autoSyncToCloud() {
            const token = githubTokenInput.value.trim();
            const gistId = gistIdInput.value.trim();
            if (!token || !gistId) return;

            isAutoSyncing = true;
            try {
                const data = getData();
                await updateGist(gistId, data);
            } catch (error) {
                console.log('Ëá™Âä®ÂêåÊ≠•Â§±Ë¥•:', error.message);
            } finally {
                isAutoSyncing = false;
            }
        }

        // ÁªëÂÆöÂêåÊ≠•ÊåâÈíÆ
        syncBtn.addEventListener('click', syncToCloud);
        pullBtn.addEventListener('click', pullFromCloud);

        // Ëé∑ÂèñÂÆåÊï¥Êï∞ÊçÆÔºàÂæÖÂäû+ËÆ∞Ë¥¶Ôºâ
        function getData() {
            const data = storage.getItem(DATA_STORAGE_KEY);
            if (data) {
                return JSON.parse(data);
            }
            return { todos: [], records: [] };
        }

        // ‰øùÂ≠òÂÆåÊï¥Êï∞ÊçÆ
        function saveData(data) {
            storage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));
        }

        // Ëé∑ÂèñÂæÖÂäûÂàóË°®ÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
        function getTodos() {
            const data = getData();
            return data.todos || [];
        }

        // ‰øùÂ≠òÂæÖÂäûÂàóË°®ÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
        function saveTodos(todos) {
            const data = getData();
            data.todos = todos;
            saveData(data);
        }

        // Ëé∑ÂèñÊî∂ÂÖ•ËÆ∞ÂΩï
        function getIncomes() {
            const data = getData();
            return data.incomes || [];
        }

        // ‰øùÂ≠òÊî∂ÂÖ•ËÆ∞ÂΩï
        function saveIncomes(incomes) {
            const data = getData();
            data.incomes = incomes;
            saveData(data);
        }

        // Ëé∑ÂèñÊîØÂá∫ËÆ∞ÂΩï
        function getExpenses() {
            const data = getData();
            return data.expenses || [];
        }

        // ‰øùÂ≠òÊîØÂá∫ËÆ∞ÂΩï
        function saveExpenses(expenses) {
            const data = getData();
            data.expenses = expenses;
            saveData(data);
        }

        // Ê∏≤ÊüìÂæÖÂäûÂàóË°®
        function renderTodos() {
            const todos = getTodos();
            todoList.innerHTML = '';

            if (todos.length === 0) {
                emptyState.style.display = 'block';
                todoCount.textContent = '';
            } else {
                emptyState.style.display = 'none';
                todoCount.textContent = `ÂÖ± ${todos.length} È°πÂæÖÂäû`;

                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.className = 'todo-item';
                    li.innerHTML = `
                        <span class="todo-text">${escapeHtml(todo.text)}</span>
                        <button class="delete-btn" data-index="${index}">Âà†Èô§</button>
                    `;
                    todoList.appendChild(li);
                });
            }
        }

        // ËΩ¨‰πâ HTML Èò≤Ê≠¢ XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Ê∑ªÂä†ÂæÖÂäû
        function addTodo() {
            const text = todoInput.value.trim();
            if (!text) {
                todoInput.focus();
                return;
            }

            const todos = getTodos();
            todos.push({
                text: text,
                createdAt: Date.now()
            });
            saveTodos(todos);
            todoInput.value = '';
            renderTodos();
            todoInput.focus();

            // Ëá™Âä®ÂêåÊ≠•
            if (autoSyncCheckbox.checked && !isAutoSyncing) {
                autoSyncToCloud();
            }
        }

        // Âà†Èô§ÂæÖÂäû
        function deleteTodo(index) {
            const item = todoList.children[index];
            if (item) {
                item.classList.add('removing');
                setTimeout(() => {
                    const todos = getTodos();
                    todos.splice(index, 1);
                    saveTodos(todos);
                    renderTodos();

                    // Ëá™Âä®ÂêåÊ≠•
                    if (autoSyncCheckbox.checked && !isAutoSyncing) {
                        autoSyncToCloud();
                    }
                }, 300);
            }
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        addBtn.addEventListener('click', addTodo);

        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        todoList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                deleteTodo(index);
            }
        });

        // ËÆ∞Ë¥¶ÂäüËÉΩ
        function addRecord() {
            const amount = parseFloat(amountInput.value);
            const note = noteInput.value.trim();

            if (!amount || amount <= 0) {
                amountInput.focus();
                return;
            }

            const records = getRecords();
            records.push({
                amount: amount,
                note: note || 'Êú™Ê†áÊ≥®',
                createdAt: Date.now()
            });
            saveRecords(records);
            amountInput.value = '';
            noteInput.value = '';
            renderRecords();
            amountInput.focus();

            // Ëá™Âä®ÂêåÊ≠•
            if (autoSyncCheckbox.checked && !isAutoSyncing) {
                autoSyncToCloud();
            }
        }

        function deleteRecord(index) {
            const item = recordList.children[index];
            if (item) {
                item.classList.add('removing');
                setTimeout(() => {
                    const records = getRecords();
                    records.splice(index, 1);
                    saveRecords(records);
                    renderRecords();

                    // Ëá™Âä®ÂêåÊ≠•
                    if (autoSyncCheckbox.checked && !isAutoSyncing) {
                        autoSyncToCloud();
                    }
                }, 300);
            }
        }

        function renderRecords() {
            // Ê∏≤ÊüìÊî∂ÂÖ•
            const incomes = getIncomes();
            const totalIncome = incomes.reduce((sum, r) => sum + r.amount, 0);
            totalBalanceEl.textContent = '¬•' + totalIncome.toLocaleString();

            incomeList.innerHTML = '';
            if (incomes.length === 0) {
                emptyIncomeState.style.display = 'block';
            } else {
                emptyIncomeState.style.display = 'none';
                [...incomes].reverse().forEach((record, reverseIndex) => {
                    const index = incomes.length - 1 - reverseIndex;
                    const li = document.createElement('li');
                    li.className = 'record-item income';
                    li.innerHTML = `
                        <div class="record-info">
                            <div class="record-amount">+¬•${record.amount}</div>
                            <div class="record-note">${escapeHtml(record.note)}</div>
                            <div class="record-time">${formatDate(record.createdAt)}</div>
                        </div>
                        <button class="delete-btn" data-index="${index}" data-type="income">Âà†Èô§</button>
                    `;
                    incomeList.appendChild(li);
                });
            }

            // Ê∏≤ÊüìÊîØÂá∫
            const expenses = getExpenses();
            const totalExpense = expenses.reduce((sum, r) => sum + r.amount, 0);
            totalExpenseEl.textContent = '¬•' + totalExpense.toLocaleString();

            expenseList.innerHTML = '';
            if (expenses.length === 0) {
                emptyExpenseState.style.display = 'block';
            } else {
                emptyExpenseState.style.display = 'none';
                [...expenses].reverse().forEach((record, reverseIndex) => {
                    const index = expenses.length - 1 - reverseIndex;
                    const li = document.createElement('li');
                    li.className = 'record-item expense';
                    li.innerHTML = `
                        <div class="record-info">
                            <div class="record-amount">-¬•${record.amount}</div>
                            <div class="record-note">${escapeHtml(record.note)}</div>
                            <div class="record-time">${formatDate(record.createdAt)}</div>
                        </div>
                        <button class="delete-btn" data-index="${index}" data-type="expense">Âà†Èô§</button>
                    `;
                    expenseList.appendChild(li);
                });
            }
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0') + ' ' +
                   String(date.getHours()).padStart(2, '0') + ':' +
                   String(date.getMinutes()).padStart(2, '0');
        }

        // Ê∑ªÂä†Êî∂ÂÖ•
        function addIncome() {
            const amount = parseFloat(amountInput.value);
            const note = noteInput.value.trim();

            if (!amount || amount <= 0) {
                amountInput.focus();
                return;
            }

            const incomes = getIncomes();
            incomes.push({
                amount: amount,
                note: note || 'Êú™Ê†áÊ≥®',
                createdAt: Date.now()
            });
            saveIncomes(incomes);
            amountInput.value = '';
            noteInput.value = '';
            renderRecords();
            amountInput.focus();

            if (autoSyncCheckbox.checked && !isAutoSyncing) {
                autoSyncToCloud();
            }
        }

        // Ê∑ªÂä†ÊîØÂá∫
        function addExpense() {
            const amount = parseFloat(amountInput.value);
            const note = noteInput.value.trim();

            if (!amount || amount <= 0) {
                amountInput.focus();
                return;
            }

            const expenses = getExpenses();
            expenses.push({
                amount: amount,
                note: note || 'Êú™Ê†áÊ≥®',
                createdAt: Date.now()
            });
            saveExpenses(expenses);
            amountInput.value = '';
            noteInput.value = '';
            renderRecords();
            amountInput.focus();

            if (autoSyncCheckbox.checked && !isAutoSyncing) {
                autoSyncToCloud();
            }
        }

        // Âà†Èô§ËÆ∞ÂΩï
        function deleteRecord(index, type) {
            const listEl = type === 'income' ? incomeList : expenseList;
            const item = listEl.children[index];
            if (item) {
                item.classList.add('removing');
                setTimeout(() => {
                    if (type === 'income') {
                        const incomes = getIncomes();
                        incomes.splice(index, 1);
                        saveIncomes(incomes);
                    } else {
                        const expenses = getExpenses();
                        expenses.splice(index, 1);
                        saveExpenses(expenses);
                    }
                    renderRecords();

                    if (autoSyncCheckbox.checked && !isAutoSyncing) {
                        autoSyncToCloud();
                    }
                }, 300);
            }
        }

        // ËÆ∞Ë¥¶‰∫ã‰ª∂ÁõëÂê¨
        addIncomeBtn.addEventListener('click', addIncome);
        addExpenseBtn.addEventListener('click', addExpense);

        amountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                noteInput.focus();
            }
        });

        noteInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addIncome();
            }
        });

        incomeList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                deleteRecord(index, 'income');
            }
        });

        expenseList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                deleteRecord(index, 'expense');
            }
        });

        // ÂàùÂßãÂåñ
        renderTodos();
        renderRecords();
    </script>
</body>
</html>
