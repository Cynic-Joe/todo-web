<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∫∏ÈªÑÂæÖÂäû</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #FFF8DC;
            --card-bg: #FFFAE8;
            --text-primary: #5D4E37;
            --text-secondary: #8B7355;
            --border-color: #E8DCC8;
            --shadow-color: rgba(93, 78, 55, 0.1);
            --btn-bg: #5D4E37;
            --btn-text: #FFFAE8;
            --btn-hover: #4A3F2D;
            --delete-color: #C75D5D;
            --delete-hover: #A84848;
            --input-bg: #FFFAE8;
            --placeholder-color: #B8A889;
            --sync-success: #5D8E5D;
            --sync-error: #C75D5D;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 16px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 4px;
        }

        .header .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ËÆæÁΩÆÂå∫Âüü */
        .settings {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .settings-header h3 {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .settings-toggle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .settings-content {
            display: none;
            margin-top: 16px;
        }

        .settings-content.show {
            display: block;
        }

        .settings-group {
            margin-bottom: 12px;
        }

        .settings-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .settings-group input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .settings-group input:focus {
            outline: none;
            border-color: var(--text-secondary);
        }

        .settings-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--btn-bg);
            color: var(--btn-text);
        }

        .btn-primary:hover {
            background: var(--btn-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--sync-success);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sync-status {
            font-size: 12px;
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }

        .sync-status.show {
            display: block;
        }

        .sync-status.success {
            background: rgba(93, 142, 93, 0.15);
            color: var(--sync-success);
        }

        .sync-status.error {
            background: rgba(199, 93, 93, 0.15);
            color: var(--sync-error);
        }

        .sync-status.loading {
            background: rgba(139, 115, 85, 0.15);
            color: var(--text-secondary);
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--text-secondary);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .input-wrapper input::placeholder {
            color: var(--placeholder-color);
        }

        .add-btn {
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 500;
            background-color: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
        }

        .add-btn:hover {
            background-color: var(--btn-hover);
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        .todo-list {
            list-style: none;
        }

        .todo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 12px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: fadeIn 0.3s ease;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .todo-item .todo-text {
            flex: 1;
            font-size: 16px;
            word-break: break-word;
        }

        .todo-item .delete-btn {
            padding: 8px 16px;
            font-size: 14px;
            background-color: transparent;
            color: var(--delete-color);
            border: 1px solid var(--delete-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 12px;
        }

        .todo-item .delete-btn:hover {
            background-color: var(--delete-color);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
        }

        .todo-count {
            text-align: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        .todo-item.removing {
            animation: fadeOut 0.3s ease forwards;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 24px;
                letter-spacing: 2px;
            }

            .input-group {
                flex-direction: column;
                gap: 10px;
            }

            .add-btn {
                width: 100%;
                padding: 14px;
            }

            .todo-item {
                padding: 14px;
            }

            .todo-item .delete-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .settings-actions {
                flex-direction: column;
            }

            .settings-actions .btn {
                width: 100%;
            }
        }

        @media (min-width: 768px) {
            .container {
                padding: 48px 24px;
            }

            .header h1 {
                font-size: 32px;
            }

            .todo-item {
                padding: 18px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ÂæÖÂäû‰∫ãÈ°π</h1>
            <p class="subtitle">ËÆ∞ÂΩïÊØè‰∏ÄÂ§©ÁöÑÂæÖÂäû</p>
        </header>

        <!-- ËÆæÁΩÆÂå∫Âüü -->
        <div class="settings">
            <div class="settings-header" id="settingsToggle">
                <h3>‰∫ëÂêåÊ≠•ËÆæÁΩÆ (GitHub Gist)</h3>
                <span class="settings-toggle" id="toggleIcon">Â±ïÂºÄ</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="settings-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div class="settings-group">
                    <label>Gist IDÔºàÈ¶ñÊ¨°ÁïôÁ©∫ÂàõÂª∫Êñ∞GistÔºâ</label>
                    <input type="text" id="gistId" placeholder="xxxxxx">
                </div>
                <div class="settings-actions">
                    <button class="btn btn-primary" id="syncBtn">ÂêåÊ≠•Âà∞‰∫ëÁ´Ø</button>
                    <button class="btn btn-secondary" id="pullBtn">‰ªé‰∫ëÁ´ØÊãâÂèñ</button>
                </div>
                <div class="sync-status" id="syncStatus"></div>
            </div>
        </div>

        <div class="input-group">
            <div class="input-wrapper">
                <input type="text" id="todoInput" placeholder="Ê∑ªÂä†Êñ∞ÁöÑÂæÖÂäû‰∫ãÈ°π..." maxlength="100">
            </div>
            <button class="add-btn" id="addBtn">Ê∑ªÂä†</button>
        </div>

        <ul class="todo-list" id="todoList"></ul>

        <div class="empty-state" id="emptyState">
            <div class="icon">üìù</div>
            <p>ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π</p>
        </div>

        <div class="todo-count" id="todoCount"></div>
    </div>

    <script>
        // ÂæÖÂäû‰∫ãÈ°πÂ∫îÁî®
        const TODO_STORAGE_KEY = 'zhihuang_todos';
        const GITHUB_TOKEN_KEY = 'zhihuang_github_token';
        const GIST_ID_KEY = 'zhihuang_gist_id';

        // Ê£ÄÊü• localStorage ÊòØÂê¶ÂèØÁî®
        let storage = localStorage;
        try {
            localStorage.setItem('__test__', 'test');
            localStorage.removeItem('__test__');
        } catch (e) {
            console.warn('localStorage ‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
            storage = {
                _data: {},
                getItem: function(key) { return this._data[key] || null; },
                setItem: function(key, value) { this._data[key] = value; },
                removeItem: function(key) { delete this._data[key]; }
            };
        }

        // DOM ÂÖÉÁ¥†
        const todoInput = document.getElementById('todoInput');
        const addBtn = document.getElementById('addBtn');
        const todoList = document.getElementById('todoList');
        const emptyState = document.getElementById('emptyState');
        const todoCount = document.getElementById('todoCount');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');
        const toggleIcon = document.getElementById('toggleIcon');
        const githubTokenInput = document.getElementById('githubToken');
        const gistIdInput = document.getElementById('gistId');
        const syncBtn = document.getElementById('syncBtn');
        const pullBtn = document.getElementById('pullBtn');
        const syncStatus = document.getElementById('syncStatus');

        // ÂàùÂßãÂåñËÆæÁΩÆ
        githubTokenInput.value = storage.getItem(GITHUB_TOKEN_KEY) || '';
        gistIdInput.value = storage.getItem(GIST_ID_KEY) || '';

        // ËÆæÁΩÆÈù¢ÊùøÂ±ïÂºÄ/Êî∂Ëµ∑
        settingsToggle.addEventListener('click', () => {
            settingsContent.classList.toggle('show');
            toggleIcon.textContent = settingsContent.classList.contains('show') ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ';
        });

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatus(message, type) {
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status show ' + type;
            setTimeout(() => {
                syncStatus.classList.remove('show');
            }, 4000);
        }

        // GitHub API Ë∞ÉÁî®
        async function githubRequest(endpoint, method, body = null) {
            const token = githubTokenInput.value.trim();
            if (!token) {
                throw new Error('ËØ∑ËæìÂÖ• GitHub Token');
            }

            const headers = {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
            };

            if (body) {
                headers['Content-Type'] = 'application/json';
            }

            const options = {
                method: method,
                headers: headers
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch('https://api.github.com' + endpoint, options);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'ËØ∑Ê±ÇÂ§±Ë¥•');
            }

            return response.json();
        }

        // ÂàõÂª∫Êñ∞ Gist
        async function createGist(todos) {
            const gist = await githubRequest('/gists', 'POST', {
                description: 'Á∫∏ÈªÑÂæÖÂäûÊï∞ÊçÆ',
                public: false,
                files: {
                    'todos.json': {
                        content: JSON.stringify(todos, null, 2)
                    }
                }
            });
            return gist.id;
        }

        // Êõ¥Êñ∞ Gist
        async function updateGist(gistId, todos) {
            await githubRequest('/gists/' + gistId, 'PATCH', {
                files: {
                    'todos.json': {
                        content: JSON.stringify(todos, null, 2)
                    }
                }
            });
        }

        // Ëé∑Âèñ Gist ÂÜÖÂÆπ
        async function getGist(gistId) {
            const gist = await githubRequest('/gists/' + gistId, 'GET');
            const content = gist.files['todos.json'].content;
            return JSON.parse(content);
        }

        // ÂêåÊ≠•Âà∞‰∫ëÁ´Ø
        async function syncToCloud() {
            const token = githubTokenInput.value.trim();
            if (!token) {
                showStatus('ËØ∑ÂÖàËæìÂÖ• GitHub Token', 'error');
                return;
            }

            syncBtn.disabled = true;
            pullBtn.disabled = true;
            showStatus('Ê≠£Âú®ÂêåÊ≠•...', 'loading');

            try {
                const todos = getTodos();
                let gistId = gistIdInput.value.trim();

                // ‰øùÂ≠ò token Âíå gistId
                storage.setItem(GITHUB_TOKEN_KEY, token);

                if (gistId) {
                    // Êõ¥Êñ∞Áé∞Êúâ Gist
                    await updateGist(gistId, todos);
                    showStatus('ÂêåÊ≠•ÊàêÂäüÔºÅ', 'success');
                } else {
                    // ÂàõÂª∫Êñ∞ Gist
                    gistId = await createGist(todos);
                    gistIdInput.value = gistId;
                    storage.setItem(GIST_ID_KEY, gistId);
                    showStatus('ÂàõÂª∫ Gist ÊàêÂäüÔºåËØ∑ËÆ∞ÂΩï‰∏ãÊñπÁöÑ Gist IDÔºÅ', 'success');
                }
            } catch (error) {
                showStatus('ÂêåÊ≠•Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                syncBtn.disabled = false;
                pullBtn.disabled = false;
            }
        }

        // ‰ªé‰∫ëÁ´ØÊãâÂèñ
        async function pullFromCloud() {
            const token = githubTokenInput.value.trim();
            const gistId = gistIdInput.value.trim();

            if (!token) {
                showStatus('ËØ∑ÂÖàËæìÂÖ• GitHub Token', 'error');
                return;
            }

            if (!gistId) {
                showStatus('ËØ∑ÂÖàËæìÂÖ• Gist ID ÊàñÂÖàÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'error');
                return;
            }

            syncBtn.disabled = true;
            pullBtn.disabled = true;
            showStatus('Ê≠£Âú®ÊãâÂèñ...', 'loading');

            try {
                const todos = await getGist(gistId);
                saveTodos(todos);
                renderTodos();
                showStatus('ÊãâÂèñÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                showStatus('ÊãâÂèñÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                syncBtn.disabled = false;
                pullBtn.disabled = false;
            }
        }

        // ÁªëÂÆöÂêåÊ≠•ÊåâÈíÆ
        syncBtn.addEventListener('click', syncToCloud);
        pullBtn.addEventListener('click', pullFromCloud);

        // Ëé∑ÂèñÂæÖÂäûÂàóË°®
        function getTodos() {
            const todos = storage.getItem(TODO_STORAGE_KEY);
            return todos ? JSON.parse(todos) : [];
        }

        // ‰øùÂ≠òÂæÖÂäûÂàóË°®
        function saveTodos(todos) {
            storage.setItem(TODO_STORAGE_KEY, JSON.stringify(todos));
        }

        // Ê∏≤ÊüìÂæÖÂäûÂàóË°®
        function renderTodos() {
            const todos = getTodos();
            todoList.innerHTML = '';

            if (todos.length === 0) {
                emptyState.style.display = 'block';
                todoCount.textContent = '';
            } else {
                emptyState.style.display = 'none';
                todoCount.textContent = `ÂÖ± ${todos.length} È°πÂæÖÂäû`;

                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.className = 'todo-item';
                    li.innerHTML = `
                        <span class="todo-text">${escapeHtml(todo.text)}</span>
                        <button class="delete-btn" data-index="${index}">Âà†Èô§</button>
                    `;
                    todoList.appendChild(li);
                });
            }
        }

        // ËΩ¨‰πâ HTML Èò≤Ê≠¢ XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Ê∑ªÂä†ÂæÖÂäû
        function addTodo() {
            const text = todoInput.value.trim();
            if (!text) {
                todoInput.focus();
                return;
            }

            const todos = getTodos();
            todos.push({
                text: text,
                createdAt: Date.now()
            });
            saveTodos(todos);
            todoInput.value = '';
            renderTodos();
            todoInput.focus();
        }

        // Âà†Èô§ÂæÖÂäû
        function deleteTodo(index) {
            const item = todoList.children[index];
            if (item) {
                item.classList.add('removing');
                setTimeout(() => {
                    const todos = getTodos();
                    todos.splice(index, 1);
                    saveTodos(todos);
                    renderTodos();
                }, 300);
            }
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        addBtn.addEventListener('click', addTodo);

        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        todoList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                deleteTodo(index);
            }
        });

        // ÂàùÂßãÂåñ
        renderTodos();
    </script>
</body>
</html>
